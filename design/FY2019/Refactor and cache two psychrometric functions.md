# Refactor and cache two psychrometric functions

Xuan Luo, Tianzhen Hong

Lawrence Berkeley National Laboratory

July 25, 2019 

## Justification for Feature Update

The feature is to convert the funtion `PsyTsatFnHPb` from Fortran code to C++ code, and use caching for two psychrometric funtions - `PsyTsatFnHPb` & `PsyTsatFnPb`.

The caching helps achieve run time performance gain but may trigger some small differences in the reported results. Table 1 summarizes the regression diffs of the two psychrometric functions. The summary is based on the regression test results with 623 EnergyPlus test files. The max diff in annual energy/facility report indicates the maximum relative difference in the summary tables, out of the total 623 tests. The math diffs indicate the differences in the reported variables and meters by hour or by time step. The tables diffs indicate the differences in the final report tables.

**Table 1. Regression diffs of two psychrometric functions - annual**

| ﻿Trade off flags       | Number of tests have large math diffs | Number of tests have large table diffs | Annual Site EUI   |                                | Annual Energy Meters Entire Facility - Electricity |                                | Annual Energy Meters Entire Facility - Gas |                                | Annual Energy Meters Entire Facility - Cooling |                                | Annual Energy Meters Entire Facility - Water |                                | Annual Energy Meters Entire Facility - Other |                                |
|-----------------------|---------------------------------------|----------------------------------------|-------------------|--------------------------------|----------------------------------------------------|--------------------------------|--------------------------------------------|--------------------------------|------------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|
|                       |                                       |                                        | Max relative diff | # test cases have diff > 0.01% | Max relative diff                                  | # test cases have diff > 0.01% | Max relative diff                          | # test cases have diff > 0.01% | Max relative diff                              | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% |
| EP_cache_PsyTsatFnPb  | 43                                    | 23                                     | 0.10%             | 7                              | 0.11%                                              | 7                              | 0.02%                                      | 2                              | 0.02%                                          | 3                              | 0.23%                                        | 12                             | 0.09%                                        | 6                              |
| EP_cache_PsyTsatFnHPb | 57                                    | 34                                     | 0.06%             | 10                             | 0.06%                                              | 9                              | 0.02%                                      | 3                              | 0.02%                                          | 5                              | 0.18%                                        | 12                             | 0.09%                                        | 8                              |

The regression diffs of the peak results are summarized in Table 2.

**Table 2. Regression diffs of two psychrometric functions - peak**

| ﻿Trade off flags       | Annual Energy Meters Entire Facility - Electricity |                                | Annual Energy Meters Entire Facility - Gas |                                | Annual Energy Meters Entire Facility - Cooling |                                | Annual Energy Meters Entire Facility - Water |                                | Annual Energy Meters Entire Facility - Other |                                |
|-----------------------|----------------------------------------------------|--------------------------------|--------------------------------------------|--------------------------------|------------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|----------------------------------------------|--------------------------------|
|                       | Max relative diff                                  | # test cases have diff > 0.01% | Max relative diff                          | # test cases have diff > 0.01% | Max relative diff                              | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% | Max relative diff                            | # test cases have diff > 0.01% |
| EP_cache_PsyTsatFnPb  | 4.30%                                              | 2                              | 0.47%                                      | 1                              | 0.12%                                          | 1                              | N/A                                          | 0                              | 0.72                                         | 2                              |
| EP_cache_PsyTsatFnHPb | 4.20%                                              | 3                              | 0.31%                                      | 1                              | 0.04%                                          | 2                              | N/A                                          | 0                              | 0.60%                                        | 2                              |

We further took some example files and analyzed where the big diffs show in each test case. The big deviations mainly appear in fields including heating and cooling capacity, convergence information, annual peak (minimum and maximum) values and setpoint not met (Table 3). This indicates that at some extreme conditions, minor (10^-16) precision difference in the calculation of psychrometric function can cause cumulative effect in simulation results.

We summarized the diff analysis of the ESO file with each malfunctioning test case for the PsyTsatFnPb function, including (1) if the file has large abs value at large rel diff hours for some attributes, (2) maximum #hours with big ref diff at abs values out of 8760, and (3) most significant deviated attribute. A more detailed diff analysis by attributes is attached in a spreadsheet. For most of the files with large math diffs, the diff happens only in a few hours for some sensitive fields, and by the diff-of-warning-messages many of them are triggered by the inconsistent number of iterations for convergence. For example, the reference supermarket has large math diff in total heating energy during one peak hour only. For 5ZoneVAV-ChilledWaterStorage-Mixed, the cached version somehow converges in less number of iterations for some HVAC loops, and that's accounting for the diffs in Solver Iteration Count. Other files with diffs originally have some existing severe error and warnings which I assume can be vulnerable now, and their behaviors can deviate in subroutines such as cooling tower and heat pumps. None of those behaviors leads to large diffs in annual energy use though.


**Table 3. Regression diffs analysis of the PsyTsatFnPb function**


|File name                                              |Max #hours in a year ESO has large abs value at large rel diffs|Notes                             |Malfunctioning attribute                                    |
|-------------------------------------------------------|---------------------------------------------------------------|----------------------------------|------------------------------------------------------------|
|2ZoneDataCenterHVAC_wEconomizer                        |952                                                            |Diffs in pre-existing severe error|Chiller Evaporator Inlet Temperature                        |
|UserDefinedRoomAirPatterns                             |502                                                            |Diffs in pre-existing warnings    |RETURN OUTLET:System Node Enthalpy                          |
|GasTurbChillerHeatRecoveryAuto                         |321                                                            |                                  |Chiller Evaporator Inlet Temperature                        |
|ShopWithPVandStorage                                   |10                                                             |OK                                |Inverter Thermal Loss Rate                                  |
|MultiSpeedHP_StagedThermostat                          |113                                                            |                                  |Zone Air System Sensible Heating Energy                     |
|ElectricEIRChillerHeatRecoveryAuto                     |1                                                              |OK                                |REHEAT COIL ZONE 1:Heating Coil Heating Rate                |
|HeatPumpWaterHeaterStratified                          |2                                                              |OK                                |Water Heater Source Side Heat Transfer Rate                 |
|HospitalLowEnergy                                      |132                                                            |Diffs in pre-existing warnings    |LAB 1:Zone Air Relative Humidity                            |
|5ZoneCoolBeam                                          |15                                                             |OK                                |Chiller Evaporator Cooling Rate                             |
|VSHeatPumpWaterHeater                                  |165                                                            |Diffs in pre-existing severe error|Water Heater Source Side Inlet Temperature                  |
|CoolingTower_VariableSpeed_IdealCondEntTempSetpoint    |72                                                             |OK                                |CONDENSER TOWER OUTLET NODE:System Node Setpoint Temperature|
|CentralChillerHeaterSystem_Simultaneous_Cooling_Heating|4469                                                           |                                  |Ground Heat Exchanger Inlet Temperature                     |
|5ZoneVAV-ChilledWaterStorage-Mixed_DCV_MaxZd           |3                                                              |OK                                |HVAC System Solver Iteration Count                          |
|5ZoneCoolingPanelBaseboardAuto                         |35                                                             |OK                                |Chiller Evaporator Cooling Rate                             |
|DualDuctVarVolDamper                                   |1                                                              |OK                                |Air System Simulation Maximum Iteration Count               |
|ChangeoverBypassVAV_AirToAirHeatPump                   |107                                                            |                                  |Unitary System Bypass Air Mass Flow Rate                    |
|5ZoneVAV-ChilledWaterStorage-Mixed_DCV_MultiPath       |3                                                              |OK                                |HVAC System Solver Iteration Count                          |
|HeatRecoveryPlantLoopAuto                              |35                                                             |OK                                |BIG CHILLER:Chiller Condenser Heat Transfer Rate            |
|5ZoneIceStorage                                        |8                                                              |OK                                |Ice Thermal Storage Requested Load                          |
|TermRhSingleHeatCoolNoDB                               |1                                                              |OK                                |Zone Air System Sensible Heating Rate                       |
|5ZoneVAV-ChilledWaterStorage-Stratified                |2                                                              |OK                                |Air System Simulation Iteration Count                       |
|RefBldgSuperMarketNew2004_Chicago                      |1                                                              |OK                                |Air System Total Heating Energy                             |
|ChangeoverBypassVAV_AirToAir                           |98                                                             |OK                                |Unitary System Bypass Air Mass Flow Rate                    |
|DualDuctConstVolDamperMultizoneAverageSetPointManager |1                                                              |OK                                |Air System Simulation Iteration Count                       |
|ChangeoverBypassVAV                                    |100                                                            |OK                                |Unitary System Bypass Air Mass Flow Rate                    |
|ChangeoverBypassVAV_MaxTemp                            |117                                                            |OK                                |Unitary System Bypass Air Mass Flow Rate                    |
|HeatRecoveryElectricChiller                            |453                                                            |                                  |BIG WATER HEATER:Water Heater Net Heat Transfer Energy      |
|5ZoneWaterLoopHeatPump                                 |6                                                              |OK                                |Chiller Evaporator Outlet Temperature                       |
|TermRhDualSetpointWithDB                               |1                                                              |OK                                |Zone Air System Sensible Heating Rate                       |
|HeatPumpWaterHeater                                    |82                                                             |OK                                |HPWHPLANTTANK:Water Heater Use Side Mass Flow Rate          |
|RefrigeratedWarehouse                                  |32                                                             |OK                                |Zone Mixing Latent Heat Loss Energy                         |
|5ZoneVAV-ChilledWaterStorage-Mixed                     |7                                                              |OK                                |HVAC System Solver Iteration Count                          |
|CompSetPtControl                                       |2360                                                           |                                  |Chiller Evaporator Mass Flow Rate                           |
|HVACTemplate-5ZoneFanCoil-DOAS                         |11                                                             |OK                                |Heating Coil Heating Rate                                   |
|CentralChillerHeaterSystem_Cooling_Heating             |3512                                                           |                                  |Ground Heat Exchanger Outlet Temperature                    |
|FourPipeBeamLargeOffice                                |1                                                              |OK                                |Chiller Evaporator Mass Flow Rate                           |
|5ZoneAirCooledDemandLimiting_FixedRateVentilation      |2                                                              |OK                                |Pump Electric Power                                         |
