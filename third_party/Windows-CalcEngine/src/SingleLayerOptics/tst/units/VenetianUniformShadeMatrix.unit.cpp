#include <memory>
#include <gtest/gtest.h>

#include "WCECommon.hpp"
#include "WCESingleLayerOptics.hpp"

class TestVenetianUniformShadeMatrix : public testing::Test
{
private:
    std::shared_ptr<SingleLayerOptics::CBSDFLayer> m_Shade;

protected:
    virtual void SetUp()
    {
        // create material
        const auto Tmat = 0.1;
        const auto Rfmat = 0.7;
        const auto Rbmat = 0.7;
        const auto minLambda = 0.3;
        const auto maxLambda = 2.5;
        const auto aMaterial = SingleLayerOptics::Material::singleBandMaterial(
          Tmat, Tmat, Rfmat, Rbmat, minLambda, maxLambda);

        // make cell geometry
        const auto slatWidth = 0.010;     // m
        const auto slatSpacing = 0.010;   // m
        const auto slatTiltAngle = 45;
        const auto curvatureRadius = 0;
        const size_t numOfSlatSegments = 5;

        // create BSDF
        const auto aBSDF =
          SingleLayerOptics::CBSDFHemisphere::create(SingleLayerOptics::BSDFBasis::Quarter);

        // make layer
        m_Shade = SingleLayerOptics::CBSDFLayerMaker::getVenetianLayer(
          aMaterial,
          aBSDF,
          slatWidth,
          slatSpacing,
          slatTiltAngle,
          curvatureRadius,
          numOfSlatSegments,
          SingleLayerOptics::DistributionMethod::UniformDiffuse);
    }

public:
    SingleLayerOptics::CBSDFLayer & GetShade()
    {
        return *m_Shade;
    };
};

TEST_F(TestVenetianUniformShadeMatrix, TestVenetianMatrix)
{
    SCOPED_TRACE("Begin Test: Venetian layer test quarter basis matrix.");

    auto & aShade = GetShade();

    auto aResults = aShade.getResults();

    FenestrationCommon::SquareMatrix & aT =
      aResults->getMatrix(FenestrationCommon::Side::Front, FenestrationCommon::PropertySimple::T);

    // clang-format off
    std::vector<std::vector<double>> correctResults{
        {3.85984,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,4.156385,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,6.422513,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,7.361174,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,6.422513,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,4.156385,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,1.890257,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.951597,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,1.890257,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,3.856836,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,7.17719,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,9.607858,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,10.497544,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,9.607858,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,7.17719,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,3.856836,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.536482,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.536482,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,3.856836,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,10.147005,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,11.254628,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,9.581077,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,11.254628,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,10.147005,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,3.856836,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,3.668835,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,3.668835,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303},
        {0.050107,0.050107,0.038595,0.033826,0.038595,0.050107,0.061619,0.066388,0.061619,0.050107,0.031904,0.018579,0.013702,0.018579,0.031904,0.050107,0.06831,0.065066,0.062441,0.065066,0.06831,0.050107,0.015623,0.022003,0.043137,0.022003,0.015623,0.050107,0.063475,0.055055,0.05249,0.055055,0.063475,0.050107,0.148234,0.131012,0.148234,0.050107,0.044303,0.042115,0.044303}
    };
    // clang-format on

    EXPECT_EQ(aT.size(), aT.size());
    for(size_t i = 0; i < aT.size(); ++i)
    {
        for(size_t j = 0u; j < aT.size(); ++j)
        {
            EXPECT_NEAR(correctResults[i][j], aT(i, j), 1e-6);
        }
    }
}
